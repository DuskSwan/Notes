主要参考：https://zhuanlan.zhihu.com/p/530602852

# 1.模型总览

如下图所示。DDPM模型主要分为两个过程：forward加噪过程（从右往左）和reverse去噪过程（从左往右）。加噪过程意思是指向数据集的真实图片中逐步加入高斯噪声，而去噪过程是指对加了噪声的图片逐步去噪，从而还原出真实图片。加噪过程满足一定的数学规律，而去噪过程则采用神经网络来学习。这么一来，神经网络就可以从一堆杂乱无章的噪声图片中生成真实图片了。

![img](img/v2-c77c080d146c4e9d9edf17e264ebdb98_1440w.webp)

# 2. Diffusion扩散过程（Forward加噪过程）

### 加噪的数学描述

给定初始数据分布$x_0∼q(x)$，我们定义一个前向扩散过程（forward diffusion process）：我们向数据分布中逐步添加高斯噪声，加噪过程持续$ T $次，产生一系列带噪声图片$ x_1,...,x_T $。在由$ x_{t−1} $加噪至$ x_t $的过程中，噪声的标准差/方差是以一个在区间$ (0,1) $内的固定值$ β_T $来确定的，均值是以固定值$ β_T $和当前时刻的图片数据$ x_{t−1} $来确定的。

具体来说，有以下公式：
$$
q(x_t|x_{t−1})\sim N(x_t;\sqrt{1−β_t}x_{t−1},β_tI) \\
q(x_{T}|x_0)= ∏_{t=1}^Tq(x_t|x_{t−1})
$$
其中$q(x_t|x_{t-1})$指的可能是$x_t$在条件$x_{t-1}$下的密度函数，也可能是概率；$N(x_t;\sqrt{1−β_t}x_{t−1},β_tI)$是指以$ \sqrt{1−β_t}x_{t−1} $为均值、$ β_tI $为协方差矩阵、给出$x_t$的高斯分布。这个记法很奇怪，它没有说明$q$到底是密度函数还是概率。

由于每一步的噪声只由$ β_T $和$ x_{t−1} $来确定，因此只要有了$ x_0 $，并且确定$β_1,...,β_T $，我们就可以推出任意一步的加噪数据$ x_1,...,x_T $。这个Forward加噪过程是一个马尔科夫链过程。

随着$ t $的不断增大，最终原始数据$ x_0 $会逐步失去它的特征。当$ T→∞ $时，$ x_T $趋近于一个各向独立的高斯分布。从视觉上来看，就是将原本一张完好的照片加噪很多步后，图片几乎变成了一张完全是噪声的图片。

### 任意时刻数据xt的计算

在逐步加噪的过程中，我们其实并不需要一步一步地从$ x_0,x_1,... $去迭代得到$ x_t $。事实上，我们可以直接从$ x_0 $和固定值序列$ \{β_t∈(0,1)\}_{t=1}^T $直接计算得到。

考虑这样一件事，只需要得到一个服从$N(0,I)$的样本$z$，然后做变换$x=Az+\mu$，就得到了服从$N(\mu,AA')$的样本$x$。这启示我们，$x_t$可以由服从$N(0,I)$的样本$z$做变换$x_t=\sqrt{\beta_t}Iz+\sqrt{1-\beta_t}x_{t-1}$得到。

我们定义$ α_t=1−β_t $，$ \bar α_t=∏_{i=1}^tα_i=∏_{i=1}^t(1−β_i)$，那么根据前述的关系，我们得到：
$$
\begin{align}
x_t &= \sqrt{\alpha_t}x_{t-1}+\sqrt{1-\alpha_t}z_{t-1} \\
&= \sqrt{\alpha_t}(\sqrt{\alpha_{t-1}}x_{t-2}+\sqrt{1-\alpha_{t-1}}z_{t-2})+\sqrt{1-\alpha_t}z_{t-1} \\
&= \sqrt{\alpha_t\alpha_{t-1}}x_{t-2}+\sqrt{\alpha_t(1-\alpha_{t-1})}z_{t-2}+\sqrt{1-\alpha_t}z_{t-1} \\
&= \sqrt{\alpha_t\alpha_{t-1}}x_{t-2}+\sqrt{1-\alpha_{t}\alpha_{t-1}}\bar z_{t-2} \\
&= \cdots \\
&= \sqrt{\bar\alpha_t}x_{0}+\sqrt{1-\bar\alpha_{t}}z \\
\end{align}
$$
先看省略号之前的部分，这里面的$z_{t-1},z_{t-2}$都是服从标准正态分布的，而$\bar z_{t-2}=\frac{\sqrt{\alpha_t(1-\alpha_{t-1})}z_{t-2}+\sqrt{1-\alpha_t}z_{t-1}}{\sqrt{1-\alpha_{t}\alpha_{t-1}}}$是两个标准正态分布的变量的线性组合，它也服从正态分布，实际上这个正态分布我们可以算出来，其均值还是$0$，方差是$\frac{\alpha_t(1-\alpha_{t-1})I+(1-\alpha_t)I}{1-\alpha_{t}\alpha_{t-1}}=I$，没想到吧，还是个标准正态分布。

于是一路替换下去，最终只剩下了$x_0$和$\bar z$两个变量，前者是已知的，后者服从标准正态分布。参数$\beta_t,\alpha_t$都给定，只要有$z$就能直接算出$x_t$了。

### βt的取值设置

一般地，随着$ t $的增大，生成的数据要更加接近随机的高斯分布，所以$ β_t $的取值应该越大。所以取$ β_1<β_2<...<β_T$，也即$\alpha_1>\alpha_2>\cdots>\alpha_T$。由于$\beta_t\in(0,1)$，直接得到$\alpha_t\in(0,1)$，进而$\bar\alpha_1>\bar\alpha_1>\cdots>\bar\alpha_T$。